trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean verify sonar:sonar'
    options: '-DskipTests -Dsonar.login=$(SONAR_TOKEN)'
  displayName: 'Build, Verify & SonarQube Analysis'

- task: DownloadSecureFile@1
  name: sshKey
  inputs:
    secureFile: 'ci-cd-vm_key.pem'  # Update this if your key file name is different

- script: |
    chmod 600 $(sshKey.secureFilePath)

    echo "Creating app directory on remote VM..."
    ssh -i $(sshKey.secureFilePath) -o StrictHostKeyChecking=no azureuser@4.172.227.190 'mkdir -p /home/azureuser/app'

    echo "Copying JAR to remote VM..."
    scp -i $(sshKey.secureFilePath) -o StrictHostKeyChecking=no target/*.jar azureuser@4.172.227.190:/home/azureuser/app/app.jar

    echo "Restarting Spring Boot app..."
    ssh -i $(sshKey.secureFilePath) -o StrictHostKeyChecking=no azureuser@4.172.227.190 << EOF
      pkill -f 'java -jar' || true
      nohup java -jar /home/azureuser/app/app.jar > /home/azureuser/app/app.log 2>&1 &
    EOF
  displayName: 'Deploy to VM2'
